<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bách Hóa Xanh - Tối Ưu Hóa Giao Hàng</title>
    <!-- Favicon (Bách Hóa Xanh Icon) -->
    <link rel="icon" type="image/png" href="./images.png">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for XLSX to CSV conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow-y: auto; 
        }
        #map { 
            height: calc(100vh - 80px); 
            width: 100%; 
            margin-top: 80px; 
            position: relative;
        }
        .header { 
            background-color: #28a745; 
            color: white; 
            padding: 10px 20px; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; 
            align-items: center; 
            justify-content: space-between;
        }
        .logo img { 
            height: 50px; 
            width: auto; 
            max-width: 100%; 
            object-fit: contain;
        }
        @media (max-width: 768px) {
            .logo img {
                height: 40px;
            }
        }
        @media (max-width: 480px) {
            .logo img {
                height: 30px;
            }
        }
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-bar { 
            width: 300px; 
            padding: 8px 30px 8px 8px; 
            border: 1px solid #ccc; 
            border-radius: 20px; 
            outline: none;
            position: relative;
            box-sizing: border-box;
            color: black;
            caret-color: black;
        }
        .search-bar::placeholder {
            color: #666;
        }
        .search-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
            z-index: 1001;
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 300px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            margin-top: 2px;
        }
        .search-suggestions.active {
            display: block;
        }
        .search-suggestion {
            padding: 8px;
            cursor: pointer;
            color: black;
        }
        .search-suggestion:hover {
            background-color: #f0f0f0;
        }
        .nav-links { 
            display: flex; 
            align-items: center;
        }
        .nav-links a, .nav-links button { 
            color: white; 
            margin-left: 20px; 
            text-decoration: none; 
            font-weight: 500; 
            background: none;
            border: none;
            cursor: pointer;
        }
        .nav-links a:hover, .nav-links button:hover { 
            text-decoration: underline; 
        }
        .sidebar { 
            position: fixed; 
            top: 80px; 
            left: 0; 
            width: 350px;
            height: calc(100vh - 80px - 70px); 
            background-color: #f8f9fa; 
            z-index: 1000; 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            overflow-y: auto; 
            display: none;
        }
        .sidebar.active {
            display: block;
        }
        .input-container {
            position: relative;
            width: 100%;
        }
        .location-input { 
            width: 100%; 
            padding: 8px; 
            padding-right: 30px; 
            margin: 5px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: white;
        }
        .dropdown-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
        }
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            z-index: 1002;
        }
        .location-suggestions.active {
            display: block;
        }
        .location-suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .location-suggestion:hover {
            background-color: #f0f0f0;
        }
        .number-input { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .file-input { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background-color: white;
        }
        .info-box { 
            margin-top: 10px; 
            padding: 10px; 
            background-color: #e9ecef; 
            border-radius: 4px; 
            display: none; 
            max-height: 200px; 
            overflow-y: auto; 
        }
        .success-message { 
            margin-top: 10px; 
            padding: 10px; 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
            border-radius: 4px; 
            display: none; 
            text-align: center; 
        }
        .footer { 
            background-color: #28a745; 
            color: white; 
            padding: 20px; 
            text-align: center; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 70px; 
            z-index: 1000;
            margin-bottom: 0;
        }
        .footer a { 
            color: #ffeb3b; 
            text-decoration: none; 
            margin: 0 10px;
        }
        .footer a:hover { text-decoration: underline; }
        .leaflet-control-zoom {
            position: fixed !important;
            right: 10px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background-color: rgba(255, 255, 255, 0.8) !important;
            border-radius: 5px !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            padding: 5px !important;
            font-size: 14px !important;
        }
        .leaflet-control-zoom a {
            width: 22px !important;
            height: 22px !important;
            line-height: 22px !important;
            font-size: 16px !important;
        }
        #logoutDropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #logoutDropdown.active {
            display: block;
        }
        #logoutButton {
            padding: 2px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAIAAACRXR/mAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABeSURBVFhH7dNBDQAgDAPB+5/0sYMtWgiM1t3r0M7M7gA2gJ2Z3QFsgDsA2AF2gJ2Z3QFsgDsA2AF2gJ2Z3QFsgDsA2AF2gJ2Z3QFsgDsA2AF2gJ2Z3QFsgDsA2AF2gJ2Z3QFsgDuAy2bNAKxYvYkWAAAAAElFTkSuQmCC" alt="Bách Hóa Xanh Logo">
        </div>
        <div class="search-container">
            <input type="text" id="storeSearch" class="search-bar" placeholder="Tìm cửa hàng...">
            <i class="fas fa-chevron-down search-arrow" id="searchArrow"></i>
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        <div class="nav-links">
            <button id="routingButton"><i class="fas fa-route"></i> Routing</button>
            <div id="userSection" class="relative">
                <a href="login.html" id="loginLink"><i class="fas fa-user"></i> <span id="loginText">Đăng Nhập</span></a>
                <div id="logoutDropdown" class="absolute">
                    <button id="logoutButton" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Đăng Xuất</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar (Hidden by Default) -->
    <div class="sidebar" id="routingSidebar">
        <div class="mt-4">
            <label class="block text-lg font-bold text-green-700">Tải dữ liệu cửa hàng</label>
            <input type="file" id="storeFile" class="file-input" accept=".xlsx,.csv">
            <button id="loadStores" class="mt-2 w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Tải dữ liệu</button>
            <div id="successMessage" class="success-message">Tải dữ liệu thành công</div>
            <label class="block text-lg font-bold text-green-700 mt-4">Tính Đường Đi</label>
            <div class="input-container">
                <input type="text" id="startLocationInput" class="location-input" placeholder="Nhập điểm bắt đầu...">
                <i class="fas fa-chevron-down dropdown-arrow" id="startDropdownArrow"></i>
                <div class="location-suggestions" id="startLocationSuggestions"></div>
            </div>
            <label class="block text-sm font-medium text-gray-700 mt-2">Số điểm đến</label>
            <input type="number" id="numDestinations" class="number-input" min="1" placeholder="Nhập số điểm đến">
            <button id="generateDestinations" class="mt-2 w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Tạo danh sách điểm đến</button>
            <div id="destinationsList" class="mt-2"></div>
            <button id="calculateRoute" class="mt-2 w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Tính đường đi</button>
            <div id="routeInfo" class="info-box"></div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Footer -->
    <footer class="footer">
        <p>© 2025 Bách Hóa Xanh. All Rights Reserved.</p>
        <p>
            <a href="https://www.bachhoaxanh.com/?srsltid=AfmBOorReHLifzL_5vYaNlYhfMSZMKcZCakmhOmLTMl4tajXkv4ltETI">Trang Chủ</a> |
            <a href="https://www.facebook.com/sieuthibachhoaxanh/?locale=vi_VN">Fanpage</a> |
            <a href="https://www.youtube.com/watch?v=EJanZHX1mb0">YouTube</a>
        </p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered on Ho Chi Minh City
        const map = L.map('map', {
            zoomControl: false
        }).setView([10.7769, 106.7009], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        let stores = [];
        let markers = [];
        let startMarker = null;
        let destinationMarkers = [];
        let searchMarker = null;

        // Define custom red icon for destinations
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        // Function to clear all markers from the map
        function clearAllMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            startMarker = null;
            destinationMarkers = [];
        }

        // Function to clear search marker
        function clearSearchMarker() {
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
        }

        // Function to update markers on the map
        function updateMarkers() {
            clearAllMarkers();

            const startIndex = document.getElementById('startLocationInput').dataset.index || '';
            if (startIndex !== '') {
                startMarker = L.marker([stores[startIndex].lat, stores[startIndex].lng])
                    .addTo(map)
                    .bindPopup(`<b>${stores[startIndex].name}</b>`);
                markers.push(startMarker);
            }

            const destinationInputs = document.querySelectorAll('.destination-container');
            destinationInputs.forEach((container, idx) => {
                const input = container.querySelector('input');
                const index = input.dataset.index || '';
                if (index !== '' && index !== startIndex) {
                    const destMarker = L.marker([stores[index].lat, stores[index].lng], { icon: redIcon })
                        .addTo(map)
                        .bindPopup(`<b>${stores[index].name}</b>`);
                    destinationMarkers.push(destMarker);
                    markers.push(destMarker);
                }
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            }
        }

        // Function to process uploaded file
        document.getElementById('loadStores').addEventListener('click', () => {
            const fileInput = document.getElementById('storeFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Vui lòng chọn file dữ liệu!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let csvData;
                if (file.name.endsWith('.xlsx')) {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    csvData = XLSX.utils.sheet_to_csv(worksheet);
                } else {
                    csvData = data;
                }

                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim(),
                    transform: (value) => value.trim(),
                    complete: (results) => {
                        stores = results.data.map(row => ({
                            name: row['Địa chỉ cửa hàng'],
                            lat: parseFloat(row['Vĩ độ']),
                            lng: parseFloat(row['Kinh độ'])
                        })).filter(store => !isNaN(store.lat) && !isNaN(store.lng));

                        updateStartInput();
                        updateDestinationInputs();
                        updateStoreSearch();
                        clearAllMarkers();
                        document.getElementById('successMessage').style.display = 'block';
                    },
                    error: (err) => alert('Lỗi khi xử lý file: ' + err.message)
                });
            };
            reader.readAsBinaryString(file);
        });

        // Function to normalize Vietnamese text by removing diacritics
        function removeVietnameseDiacritics(str) {
            const diacriticsMap = [
                { base: 'A', chars: 'ÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴ' },
                { base: 'E', chars: 'ÈÉẸẺẼÊỀẾỆỂỄ' },
                { base: 'I', chars: 'ÌÍỊỈĨ' },
                { base: 'O', chars: 'ÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠ' },
                { base: 'U', chars: 'ÙÚỤỦŨƯỪỨỰỬỮ' },
                { base: 'Y', chars: 'ỲÝỴỶỸ' },
                { base: 'D', chars: 'Đ' },
                { base: 'a', chars: 'àáạảãâầấậẩẫăằắặẳẵ' },
                { base: 'e', chars: 'èéẹẻẽêềếệểễ' },
                { base: 'i', chars: 'ìíịỉĩ' },
                { base: 'o', chars: 'òóọỏõôồốộổỗơờớợởỡ' },
                { base: 'u', chars: 'ùúụủũưừứựửữ' },
                { base: 'y', chars: 'ỳýỵỷỹ' },
                { base: 'd', chars: 'đ' },
            ];

            let normalized = str.toLowerCase();
            for (const map of diacriticsMap) {
                for (const char of map.chars) {
                    normalized = normalized.replace(new RegExp(char, 'g'), map.base);
                }
            }
            return normalized;
        }

        // Function to normalize Vietnamese text for comparison
        function normalizeVietnameseText(text) {
            return removeVietnameseDiacritics(text.toLowerCase());
        }

        // Update start location input
        function updateStartInput() {
            const startInput = document.getElementById('startLocationInput');
            const startSuggestions = document.getElementById('startLocationSuggestions');
            const startArrow = document.getElementById('startDropdownArrow');

            function updateSuggestions(query = '') {
                startSuggestions.innerHTML = '';
                if (stores.length === 0) {
                    const noData = document.createElement('div');
                    noData.className = 'location-suggestion';
                    noData.textContent = 'Không tìm thấy dữ liệu';
                    noData.style.cursor = 'default';
                    startSuggestions.appendChild(noData);
                    startSuggestions.classList.add('active');
                } else {
                    const suggestions = query.length > 0
                        ? stores.filter(store => normalizeVietnameseText(store.name).includes(query))
                        : stores;
                    if (suggestions.length > 0) {
                        suggestions.forEach((store, idx) => {
                            const storeIdx = stores.findIndex(s => s.name === store.name && s.lat === store.lat && s.lng === store.lng);
                            const div = document.createElement('div');
                            div.className = 'location-suggestion';
                            div.textContent = store.name;
                            div.dataset.index = storeIdx;
                            div.addEventListener('click', () => {
                                startInput.value = store.name;
                                startInput.dataset.index = storeIdx;
                                startSuggestions.classList.remove('active');
                                startArrow.classList.remove('fa-chevron-up');
                                startArrow.classList.add('fa-chevron-down');
                                updateMarkers();
                            });
                            startSuggestions.appendChild(div);
                        });
                        startSuggestions.classList.add('active');
                    } else {
                        const noData = document.createElement('div');
                        noData.className = 'location-suggestion';
                        noData.textContent = 'Không tìm thấy dữ liệu';
                        noData.style.cursor = 'default';
                        startSuggestions.appendChild(noData);
                        startSuggestions.classList.add('active');
                    }
                }
            }

            startInput.addEventListener('input', () => {
                const query = normalizeVietnameseText(startInput.value);
                updateSuggestions(query);
                startInput.dataset.index = '';
                updateMarkers();
            });

            startInput.addEventListener('focus', () => {
                updateSuggestions(normalizeVietnameseText(startInput.value));
            });

            startInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!startSuggestions.contains(document.activeElement) && !startArrow.contains(document.activeElement)) {
                        startSuggestions.classList.remove('active');
                        startArrow.classList.remove('fa-chevron-up');
                        startArrow.classList.add('fa-chevron-down');
                    }
                }, 200);
            });

            startArrow.addEventListener('click', () => {
                updateSuggestions(normalizeVietnameseText(startInput.value));
                if (startSuggestions.classList.contains('active')) {
                    startSuggestions.classList.remove('active');
                    startArrow.classList.remove('fa-chevron-up');
                    startArrow.classList.add('fa-chevron-down');
                } else {
                    startSuggestions.classList.add('active');
                    startArrow.classList.remove('fa-chevron-down');
                    startArrow.classList.add('fa-chevron-up');
                    startInput.focus();
                }
            });

            document.addEventListener('click', (e) => {
                if (!startInput.contains(e.target) && !startSuggestions.contains(e.target) && !startArrow.contains(e.target)) {
                    startSuggestions.classList.remove('active');
                    startArrow.classList.remove('fa-chevron-up');
                    startArrow.classList.add('fa-chevron-down');
                }
            });
        }

        // Update destination inputs
        function updateDestinationInputs() {
            const destinationsList = document.getElementById('destinationsList');
            document.getElementById('generateDestinations').addEventListener('click', () => {
                const num = parseInt(document.getElementById('numDestinations').value) || 0;
                if (num < 1 || num > stores.length) {
                    alert(`Vui lòng nhập số điểm đến từ 1 đến ${stores.length}!`);
                    document.getElementById('numDestinations').value = Math.min(Math.max(num, 1), stores.length);
                    return;
                }

                destinationsList.innerHTML = '';
                for (let i = 0; i < num; i++) {
                    const container = document.createElement('div');
                    container.className = 'destination-container mt-2';
                    const label = document.createElement('label');
                    label.className = 'block text-sm font-medium text-gray-700';
                    label.textContent = `Điểm đến ${i + 1}`;
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'input-container';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `destinationInput-${i}`;
                    input.className = 'location-input';
                    input.placeholder = `Nhập điểm đến ${i + 1}...`;
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-chevron-down dropdown-arrow';
                    arrow.id = `destinationArrow-${i}`;
                    const suggestions = document.createElement('div');
                    suggestions.id = `destinationSuggestions-${i}`;
                    suggestions.className = 'location-suggestions';
                    inputContainer.appendChild(input);
                    inputContainer.appendChild(arrow);
                    inputContainer.appendChild(suggestions);
                    container.appendChild(label);
                    container.appendChild(inputContainer);
                    destinationsList.appendChild(container);

                    function updateSuggestions(query = '') {
                        suggestions.innerHTML = '';
                        if (stores.length === 0) {
                            const noData = document.createElement('div');
                            noData.className = 'location-suggestion';
                            noData.textContent = 'Không tìm thấy dữ liệu';
                            noData.style.cursor = 'default';
                            suggestions.appendChild(noData);
                            suggestions.classList.add('active');
                        } else {
                            const suggestionsList = query.length > 0
                                ? stores.filter(store => normalizeVietnameseText(store.name).includes(query))
                                : stores;
                            if (suggestionsList.length > 0) {
                                suggestionsList.forEach((store, idx) => {
                                    const storeIdx = stores.findIndex(s => s.name === store.name && s.lat === store.lat && s.lng === store.lng);
                                    const div = document.createElement('div');
                                    div.className = 'location-suggestion';
                                    div.textContent = store.name;
                                    div.dataset.index = storeIdx;
                                    div.addEventListener('click', () => {
                                        input.value = store.name;
                                        input.dataset.index = storeIdx;
                                        suggestions.classList.remove('active');
                                        arrow.classList.remove('fa-chevron-up');
                                        arrow.classList.add('fa-chevron-down');
                                        updateMarkers();
                                    });
                                    suggestions.appendChild(div);
                                });
                                suggestions.classList.add('active');
                            } else {
                                const noData = document.createElement('div');
                                noData.className = 'location-suggestion';
                                noData.textContent = 'Không tìm thấy dữ liệu';
                                noData.style.cursor = 'default';
                                suggestions.appendChild(noData);
                                suggestions.classList.add('active');
                            }
                        }
                    }

                    input.addEventListener('input', () => {
                        const query = normalizeVietnameseText(input.value);
                        updateSuggestions(query);
                        input.dataset.index = '';
                        updateMarkers();
                    });

                    input.addEventListener('focus', () => {
                        updateSuggestions(normalizeVietnameseText(input.value));
                    });

                    input.addEventListener('blur', () => {
                        setTimeout(() => {
                            if (!suggestions.contains(document.activeElement) && !arrow.contains(document.activeElement)) {
                                suggestions.classList.remove('active');
                                arrow.classList.remove('fa-chevron-up');
                                arrow.classList.add('fa-chevron-down');
                            }
                        }, 200);
                    });

                    arrow.addEventListener('click', () => {
                        updateSuggestions(normalizeVietnameseText(input.value));
                        if (suggestions.classList.contains('active')) {
                            suggestions.classList.remove('active');
                            arrow.classList.remove('fa-chevron-up');
                            arrow.classList.add('fa-chevron-down');
                        } else {
                            suggestions.classList.add('active');
                            arrow.classList.remove('fa-chevron-down');
                            arrow.classList.add('fa-chevron-up');
                            input.focus();
                        }
                    });

                    document.addEventListener('click', (e) => {
                        if (!input.contains(e.target) && !suggestions.contains(e.target) && !arrow.contains(e.target)) {
                            suggestions.classList.remove('active');
                            arrow.classList.remove('fa-chevron-up');
                            arrow.classList.add('fa-chevron-down');
                        }
                    });
                }

                updateMarkers();
            });
        }

        // Update store search input
        function updateStoreSearch() {
            const storeSearch = document.getElementById('storeSearch');
            const searchSuggestions = document.getElementById('searchSuggestions');
            const searchArrow = document.getElementById('searchArrow');

            function updateSuggestions(query = '') {
                searchSuggestions.innerHTML = '';
                if (stores.length === 0) {
                    const noData = document.createElement('div');
                    noData.className = 'search-suggestion';
                    noData.textContent = 'Không tìm thấy dữ liệu';
                    noData.style.cursor = 'default';
                    searchSuggestions.appendChild(noData);
                    searchSuggestions.classList.add('active');
                } else {
                    const suggestions = query.length > 0
                        ? stores.filter(store => normalizeVietnameseText(store.name).includes(query))
                        : stores;
                    if (suggestions.length > 0) {
                        suggestions.forEach((store, idx) => {
                            const storeIdx = stores.findIndex(s => s.name === store.name && s.lat === store.lat && s.lng === store.lng);
                            const div = document.createElement('div');
                            div.className = 'search-suggestion';
                            div.textContent = store.name;
                            div.dataset.index = storeIdx;
                            div.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                storeSearch.value = store.name;
                                searchSuggestions.classList.remove('active');
                                searchArrow.classList.remove('fa-chevron-up');
                                searchArrow.classList.add('fa-chevron-down');
                                clearSearchMarker();
                                searchMarker = L.marker([store.lat, store.lng])
                                    .addTo(map)
                                    .bindPopup(`<b>${store.name}</b>`);
                                map.setView([store.lat, store.lng], 15);
                            });
                            searchSuggestions.appendChild(div);
                        });
                        searchSuggestions.classList.add('active');
                    } else {
                        const noData = document.createElement('div');
                        noData.className = 'search-suggestion';
                        noData.textContent = 'Không tìm thấy dữ liệu';
                        noData.style.cursor = 'default';
                        searchSuggestions.appendChild(noData);
                        searchSuggestions.classList.add('active');
                    }
                }
            }

            storeSearch.addEventListener('input', () => {
                const query = normalizeVietnameseText(storeSearch.value);
                updateSuggestions(query);
                clearSearchMarker();
            });

            storeSearch.addEventListener('focus', () => {
                updateSuggestions(normalizeVietnameseText(storeSearch.value));
            });

            storeSearch.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!searchSuggestions.contains(document.activeElement) && !searchArrow.contains(document.activeElement)) {
                        searchSuggestions.classList.remove('active');
                        searchArrow.classList.remove('fa-chevron-up');
                        searchArrow.classList.add('fa-chevron-down');
                    }
                }, 200);
            });

            searchArrow.addEventListener('click', () => {
                updateSuggestions(normalizeVietnameseText(storeSearch.value));
                if (searchSuggestions.classList.contains('active')) {
                    searchSuggestions.classList.remove('active');
                    searchArrow.classList.remove('fa-chevron-up');
                    searchArrow.classList.add('fa-chevron-down');
                } else {
                    searchSuggestions.classList.add('active');
                    searchArrow.classList.remove('fa-chevron-down');
                    searchArrow.classList.add('fa-chevron-up');
                    storeSearch.focus();
                }
            });

            document.addEventListener('click', (e) => {
                if (!storeSearch.contains(e.target) && !searchSuggestions.contains(e.target) && !searchArrow.contains(e.target)) {
                    searchSuggestions.classList.remove('active');
                    searchArrow.classList.remove('fa-chevron-up');
                    searchArrow.classList.add('fa-chevron-down');
                }
            });
        }

        // Toggle Routing Sidebar
        document.getElementById('routingButton').addEventListener('click', () => {
            const sidebar = document.getElementById('routingSidebar');
            sidebar.classList.toggle('active');
        });

        // Route calculation
        let routeLayers = [];
        document.getElementById('calculateRoute').addEventListener('click', async () => {
            const startIndex = document.getElementById('startLocationInput').dataset.index || '';
            if (startIndex === '') {
                alert('Vui lòng chọn điểm bắt đầu!');
                return;
            }

            const destinationIndices = [];
            const numDestinations = parseInt(document.getElementById('numDestinations').value) || 0;
            if (numDestinations < 1) {
                alert('Vui lòng tạo danh sách điểm đến trước!');
                return;
            }

            const destinationInputs = document.querySelectorAll('.destination-container');
            for (let i = 0; i < numDestinations; i++) {
                const input = destinationInputs[i].querySelector('input');
                if (!input) {
                    alert('Vui lòng tạo danh sách điểm đến trước!');
                    return;
                }
                const index = input.dataset.index || '';
                if (index === '') {
                    alert(`Vui lòng chọn điểm đến ${i + 1}!`);
                    return;
                }
                if (index === startIndex) {
                    alert(`Điểm đến ${i + 1} trùng với điểm bắt đầu! Vui lòng chọn điểm khác.`);
                    return;
                }
                if (destinationIndices.includes(index)) {
                    alert(`Điểm đến ${i + 1} đã được chọn trước đó! Vui lòng chọn điểm khác.`);
                    return;
                }
                destinationIndices.push(index);
            }

            if (destinationIndices.length === 0) {
                alert('Không có điểm đến hợp lệ để tính đường đi!');
                return;
            }

            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];

            const apiKey = '5b3ce3597851110001cf6248b00ac6acf0fc43ec93ea37239079ce59';
            const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';
            const routeInfo = document.getElementById('routeInfo');
            routeInfo.innerHTML = '';
            routeInfo.style.display = 'block';

            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ff00ff', '#00ffff'];
            let bounds = L.latLngBounds();

            try {
                let currentLocation = stores[startIndex];
                bounds.extend([currentLocation.lat, currentLocation.lng]);

                for (let i = 0; i < destinationIndices.length; i++) {
                    const destination = stores[destinationIndices[i]];
                    const body = {
                        coordinates: [
                            [currentLocation.lng, currentLocation.lat],
                            [destination.lng, destination.lat]
                        ]
                    };

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        throw new Error(`Không thể lấy dữ liệu đường đi cho ${currentLocation.name} -> ${destination.name}`);
                    }

                    const data = await response.json();
                    const color = colors[i % colors.length];
                    const routeLayer = L.geoJSON(data, {
                        style: { color: color, weight: 5 }
                    }).addTo(map);
                    routeLayers.push(routeLayer);
                    routeLayer.eachLayer(layer => bounds.extend(layer.getBounds()));

                    const distance = data.features[0].properties.segments[0].distance / 1000;
                    const duration = data.features[0].properties.segments[0].duration / 60;

                    const legInfo = document.createElement('div');
                    legInfo.innerHTML = `
                        <p><b>${currentLocation.name} → ${destination.name}</b></p>
                        <p>📏 Quãng đường: ${distance.toFixed(2)} km</p>
                        <p>⏱️ Thời gian dự kiến: ${duration.toFixed(1)} phút</p>
                        <hr>
                    `;
                    routeInfo.appendChild(legInfo);

                    currentLocation = destination;
                }

                map.fitBounds(bounds);
            } catch (error) {
                alert('Có lỗi xảy ra khi tính đường đi: ' + error.message);
                routeInfo.style.display = 'none';
            }
        });

        // Check if user is logged in and add logout functionality
        window.onload = function() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const loginLink = document.getElementById('loginLink');
            const loginText = document.getElementById('loginText');
            const logoutDropdown = document.getElementById('logoutDropdown');

            if (loggedInUser) {
                loginText.textContent = loggedInUser;
                loginLink.href = '#';
                loginLink.style.cursor = 'pointer';
                loginLink.onclick = toggleLogoutDropdown;
            }
        };

        function toggleLogoutDropdown(e) {
            e.preventDefault();
            const logoutDropdown = document.getElementById('logoutDropdown');
            logoutDropdown.classList.toggle('active');
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        }

        // Add event listener for logout button
        document.getElementById('logoutButton').addEventListener('click', handleLogout);

        // Hide logout dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const logoutDropdown = document.getElementById('logoutDropdown');
            const userSection = document.getElementById('userSection');
            if (!userSection.contains(e.target)) {
                logoutDropdown.classList.remove('active');
            }
        });
    </script>
</body>
</html>
